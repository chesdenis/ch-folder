@{
    ViewData["Title"] = "Ch Photo Gallery";
    var queryText = Context.Request.Query["query"].ToString();
    var selectedTags = Context.Request.Query["tags"].ToArray();
    var filters = Context.Request.Query["filters"].ToArray();
    var sorting = Context.Request.Query["sorting"].ToArray();

    // Paging and view options from query
    var currentPage = int.TryParse(Context.Request.Query["page"], out var p) ? p : 1;
    var pageSize = int.TryParse(Context.Request.Query["pageSize"], out var ps) ? ps : 12;
    var thumbSize = int.TryParse(Context.Request.Query["size"], out var sz) ? sz : 256;
    var totalItems = int.TryParse(Context.Request.Query["total"], out var ti) ? ti : 15;

    var totalPages = (int)Math.Ceiling(totalItems / (double)Math.Max(1, pageSize));
}

<div class="container-fluid mt-4 px-3">
    <form method="get" action="" class="row g-3">
        <div class="col-12 col-md-10 col-lg-11">
            <textarea class="form-control"
                      name="query"
                      placeholder="Enter search text"
                      rows="3">@queryText</textarea>
        </div>
        <div class="col-12 col-md-2 col-lg-1">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
        <!-- Size controls: placed under search area, outside of accordion -->
        <div class="col-12 d-flex gap-2">
            <button type="button" id="sizeDownBtn" class="btn btn-outline-secondary flex-fill btn-lg" aria-label="Make smaller">Make small</button>
            <button type="button" id="sizeUpBtn" class="btn btn-outline-secondary flex-fill btn-lg" aria-label="Make larger">Make large</button>
        </div>
        <div class="col-12">
            @await Component.InvokeAsync("TagsSelector", new {
                availableTags = new [] { "ASP.NET", "C#", "JavaScript", "CSS", "HTML" },
                selectedTags = ViewBag.SelectedTags as IEnumerable<string>
            })
        </div>
    </form>
    <div class="row">
        <div class="col-12 col-lg-3 mb-4">
            <div class="accordion" id="filtersAccordion">
                <!-- View Options Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#viewCollapse" aria-expanded="false" aria-controls="viewCollapse">
                            View Options
                        </button>
                    </h2>
                    <div id="viewCollapse" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <label for="pageSizeSelect" class="form-label">Images per page</label>
                                <select id="pageSizeSelect" class="form-select">
                                    @if (pageSize == 6) {<option value="6" selected>6</option>} else {<option value="6">6</option>}
                                    @if (pageSize == 12) {<option value="12" selected>12</option>} else {<option value="12">12</option>}
                                    @if (pageSize == 24) {<option value="24" selected>24</option>} else {<option value="24">24</option>}
                                    @if (pageSize == 48) {<option value="48" selected>48</option>} else {<option value="48">48</option>}
                                </select>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="button" id="applyViewOptions" class="btn btn-primary">Apply</button>
                                <button type="button" id="resetViewOptions" class="btn btn-outline-secondary">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                            Filters
                        </button>
                    </h2>
                    <div id="filtersCollapse" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-muted">No filters available</p>
                        </div>
                    </div>
                </div>

                <!-- Sorting Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#sortingCollapse" aria-expanded="false" aria-controls="sortingCollapse">
                            Sorting
                        </button>
                    </h2>
                    <div id="sortingCollapse" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-muted">No sorting options available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-9">
            @await Component.InvokeAsync("Pagination", new { currentPage, totalPages })
            @await Component.InvokeAsync("Gallery", new { page = currentPage, pageSize = pageSize, thumbSize = thumbSize })
            @await Component.InvokeAsync("Pagination", new { currentPage, totalPages })
        </div>
    </div>
</div>



@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css">
}

@section Scripts {
    <script type="module">
        import PhotoSwipeLightbox
            from 'https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe-lightbox.esm.js';

        // Helpers to manage query string
        function setQueryParam(url, key, value) {
            const u = new URL(url, window.location.origin);
            if (value === null || value === undefined || value === '') {
                u.searchParams.delete(key);
            } else {
                u.searchParams.set(key, value);
            }
            return u.toString();
        }
        function applyViewOptions() {
            const sizeSlider = document.getElementById('thumbSize');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const allowed = [16, 32, 64, 128, 256, 512, 2000];

            let url = window.location.href;
            if (sizeSlider) {
                const value = parseInt(sizeSlider.value, 10);
                const snapped = allowed.reduce((prev, curr) => Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev, allowed[0]);
                url = setQueryParam(url, 'size', String(snapped));
            }
            if (pageSizeSelect) {
                url = setQueryParam(url, 'pageSize', pageSizeSelect.value);
            }
            url = setQueryParam(url, 'page', '1'); // reset to first page when view options change
            window.location.href = url;
        }
        function resetViewOptions() {
            let url = window.location.href;
            url = setQueryParam(url, 'size', '256');
            url = setQueryParam(url, 'pageSize', '12');
            url = setQueryParam(url, 'page', '1');
            window.location.href = url;
        }
        function wireViewOptions() {
            const sizeSlider = document.getElementById('thumbSize');
            const sizeLabel = document.getElementById('thumbSizeValue');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const applyBtn = document.getElementById('applyViewOptions');
            const resetBtn = document.getElementById('resetViewOptions');

            if (sizeSlider && sizeLabel) {
                sizeSlider.addEventListener('input', () => {
                    sizeLabel.textContent = `${sizeSlider.value} px`;
                });
            }
            if (applyBtn) applyBtn.addEventListener('click', applyViewOptions);
            if (resetBtn) resetBtn.addEventListener('click', resetViewOptions);

            // Optional: submit on change without clicking Apply
            if (pageSizeSelect) pageSizeSelect.addEventListener('change', applyViewOptions);
        }

        // Two-button size control via URL param manipulation (no server action)
        function getCurrentSize() {
            const allowed = [16, 32, 64, 128, 256, 512, 2000];
            const params = new URL(window.location.href).searchParams;
            const sizeParam = parseInt(params.get('size') || '@thumbSize', 10);
            if (allowed.includes(sizeParam)) return sizeParam;
            // snap to nearest if arbitrary
            return allowed.reduce((prev, curr) => Math.abs(curr - sizeParam) < Math.abs(prev - sizeParam) ? curr : prev, allowed[0]);
        }
        function adjustSize(direction) {
            const allowed = [16, 32, 64, 128, 256, 512, 2000];
            const current = getCurrentSize();
            const idx = allowed.indexOf(current);
            let newIdx = idx;
            if (direction === 'up') newIdx = Math.min(allowed.length - 1, idx + 1);
            if (direction === 'down') newIdx = Math.max(0, idx - 1);
            const nextSize = allowed[newIdx];
            let url = window.location.href;
            url = setQueryParam(url, 'size', String(nextSize));
            url = setQueryParam(url, 'page', '1');
            window.location.href = url;
        }
        function wireSizeButtons() {
            const up = document.getElementById('sizeUpBtn');
            const down = document.getElementById('sizeDownBtn');
            if (up) up.addEventListener('click', () => adjustSize('up'));
            if (down) down.addEventListener('click', () => adjustSize('down'));
        }

        document.addEventListener('DOMContentLoaded', () => { wireViewOptions(); wireSizeButtons(); });

        const lightbox = new PhotoSwipeLightbox({
            gallery: '#my-gallery',
            children: 'a',
            pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.esm.js')
        });

        lightbox.init();
    </script>
}

<!-- Pagination Navigator -->
@{
    
}


