@{
    ViewData["Title"] = "Status";
}

<div class="row">
    <div class="col-md-10 col-lg-8">
        <h1 class="mb-3">Status</h1>

        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md-5">
                        <label class="form-label">Storage path</label>
                        <div class="form-control-plaintext" id="storagePath">@ViewBag.StoragePath</div>
                    </div>
                    <div class="col-6 col-md-3">
                        <label for="jobType" class="form-label">Job</label>
                        <select id="jobType" class="form-select">
                            <option value="MetaUploader">Meta Uploader</option>
                            <option value="AiContentQueryBuilder">AI Content Query</option>
                            <option value="Md5ImageMarker">MD5 Image Marker</option>
                            <option value="FaceHashBuilder">Face Hash Builder</option>
                            <option value="AverageImageMarker">Average Image Marker</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="dop" class="form-label">DOP</label>
                        <input id="dop" class="form-control" type="number" min="1" max="32" value="4" />
                    </div>
                    <div class="col-12 col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button id="startBtn" class="btn btn-primary w-100">Start</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <strong>Progress:</strong>
                        <span id="progressText">0%</span>
                    </div>
                    <div>
                        <span class="badge bg-secondary" id="jobIdBadge" style="display:none"></span>
                    </div>
                </div>
                <div class="progress" role="progressbar" aria-label="Job progress" aria-valuemin="0" aria-valuemax="100">
                    <div id="progressBar" class="progress-bar progress-bar-striped" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Live log</div>
            <div class="card-body">
                <pre id="log" class="mb-0" style="white-space: pre-wrap; max-height: 300px; overflow: auto"></pre>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Local SignalR browser client (installed under wwwroot/lib via LibMan) -->
    <script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
    <script>
        // Defensive check: if the client library failed to load, show a helpful message.
        if (typeof window.signalR === 'undefined') {
            console.error('SignalR client script failed to load from local path. Ensure lib files exist under wwwroot/lib/signalr.');
        }
    </script>
    <script>
        (function () {
            const startBtn = document.getElementById('startBtn');
            const bar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const log = document.getElementById('log');
            const jobIdBadge = document.getElementById('jobIdBadge');
            const jobTypeEl = document.getElementById('jobType');
            const dopEl = document.getElementById('dop');
            
            // Prepare SignalR connection as early as possible to avoid missing events
            let currentJobId = null;
            const connection = new signalR.HubConnectionBuilder()
                .withUrl('/hubs/jobstatus')
                .withAutomaticReconnect()
                .build();

            function setProgress(p) {
                p = Math.max(0, Math.min(100, p|0));
                bar.style.width = p + '%';
                bar.textContent = p + '%';
                progressText.textContent = p + '%';
            }

            function addLog(msg) {
                const time = new Date().toLocaleTimeString();
                log.textContent += `[${time}] ${msg}\n`;
                log.scrollTop = log.scrollHeight;
            }
            
            function clearLogs() {
                log.textContent = "";
            }

            // Register handlers once; they filter by currentJobId
            connection.on('ReceiveProgress', payload => {
                if (!payload || !currentJobId || payload.jobId !== currentJobId) return;
                setProgress(payload.percent || 0);
                if (payload.message) addLog(payload.message);
            });

            connection.on('ReceiveCompleted', payload => {
                if (!payload || !currentJobId || payload.jobId !== currentJobId) return;
                setProgress(100);
                addLog(payload.message || 'Completed');
                startBtn.disabled = false;
            });

            connection.on('ReceiveError', payload => {
                // Show even if jobId not set to catch early hub errors
                addLog('Error: ' + (payload?.message || 'Unknown error'));
                startBtn.disabled = false;
            });

            // Start connection on page load
            (async () => {
                try {
                    await connection.start();
                    addLog('Connected to hub.');

                    // Ensure connection is started (in case initial start failed)
                    if (connection.state !== signalR.HubConnectionState.Connected) {
                        try {
                            await connection.start();
                            addLog('Connected to hub.');
                        } catch (err) {
                            addLog('Hub connection failed: ' + err);
                            startBtn.disabled = false;
                            return;
                        }
                    }

                } catch (err) {
                    addLog('Hub connection failed: ' + err);
                }
            })();

            // If reconnected, rejoin the job group if we have one
            connection.onreconnected(async () => {
                if (currentJobId) {
                    try {
                        await connection.invoke('JoinJobGroup', currentJobId);
                        addLog('Reconnected and rejoined job group.');
                    } catch (e) {
                        addLog('Failed to rejoin group: ' + e);
                    }
                } else {
                    addLog('Reconnected.');
                }
            });

            async function startJob() {
                setProgress(0);
                clearLogs();
                addLog('Starting job...');
                startBtn.disabled = true;

                // 1) Generate jobId on client
                const newJobId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID().replace(/-/g,'') : (Date.now().toString(36) + Math.random().toString(36).slice(2));
                currentJobId = newJobId;
                jobIdBadge.textContent = currentJobId;
                jobIdBadge.style.display = '';

                // 2) Ensure hub connection is established
                if (connection.state !== signalR.HubConnectionState.Connected) {
                    try {
                        await connection.start();
                        addLog('Connected to hub.');
                    } catch (err) {
                        addLog('Hub connection failed: ' + err);
                        startBtn.disabled = false;
                        return;
                    }
                }

                // 3) Join group BEFORE starting the job
                try {
                    await connection.invoke('JoinJobGroup', currentJobId);
                    addLog('Joined job group.');
                } catch (e) {
                    addLog('Failed to join group: ' + e);
                    startBtn.disabled = false;
                    return;
                }

                // 4) Start the job passing the jobId
                const body = new URLSearchParams({
                    jobId: currentJobId,
                    type: jobTypeEl.value,
                    dop: (dopEl.value||'').toString()
                });
                const resp = await fetch('@Url.Action("IndexJob", "Home")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body
                });
                if (!resp.ok) {
                    addLog('Failed to start job: ' + resp.status);
                    startBtn.disabled = false;
                    return;
                }
                addLog('Job started: ' + currentJobId);
            }

            startBtn.addEventListener('click', (e) => {
                e.preventDefault();
                startJob().catch(err => {
                    addLog('Failed: ' + err);
                    startBtn.disabled = false;
                });
            });
        })();
    </script>
}
